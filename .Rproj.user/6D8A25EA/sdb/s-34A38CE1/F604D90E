{
    "collab_server" : "",
    "contents" : "---\nauthor: Andrea Onofri\ntitle: I modelli ANCOVA\ndate: 13 Giugno 2018\noutput:\n  pdf_document:\n    fig_width: 5\n    keep_tex: yes\n    number_sections: yes\n    template: /Users/andrea/Documents/_DBXAndrea/Dropbox/MyTemplates/Latex/mmLatexSimpleIta.tex \n    toc: yes\n---\n\n# Introduzione\n\nNella pratica sperimentale si è spesso interessati a confrontare le curve di regressione ottenute con soggetti ascrivibili a diversi gruppi, come ad esempio le risposte produttive a dosi crescenti di concimazione azotata mostrate da varietà/specie diverse. In questo genere di esperimenti la variabile rilevata è quantitativa (es. la produzione), mentre abbiamo due variabili esplicative, una quantitativa (es. la dose di concime) ed una qualitativa (la varietà). In una situazione del genere, l’interesse del ricercatore è quello di confrontare, ad esempio, le pendenze o le intercette delle diverse curve di risposta. Rientrano in quest’ambito i cosidetti test di parallelismo, che consistono nel confrontare i parametri che codificano per la posizione (e non per la forma) di curve diverse, come ad esempio le pendenze di diverse rette. I modelli di questo tipo (cioè con una variabile dipendente, un regressore e un fattore sperimentale) sono detti modelli ANCOVA.\n\nNell'esposizione precedente abbiamo illustrato l'ANCOVA come una sorta di analisi di regressione per gruppi; tradizionalmente, l'ANCOVA viene invece guardata come un'ANOVA nella quale i soggetti di ogni gruppo sono sottoposti a diversi livelli di una certa variabile quantitativa. In questo caso, nel fare il confronto tra gruppi, è giusto considerare un livello analogo della variabile dipendente, aggiustando opportunamente le medie dei diversi gruppi.  \n\nInsomma, i modelli ANCOVA possono essere utilizzati per onseguire finalità diverse, anche se le procedure di model fitting sono sempre le stesse. Illustriamo l'ANCOVA con l’aiuto di un esempio.\n\n# Esempio\n\nUn ricercatore vuole valutare se un erbicida per la barbabietola da zucchero (phenmedipham: P), nel suolo, degrada più o meno velocemente in presenza di altri erbicidi, cioè metamitron (M) e chloridazon (C). Per questo motivo, viene impostato un esperimento in cella climatica a 20°C, dove campioni dello stesso suolo sono stati contaminati con P, P+M, P+C e P+M+C. L'esperimento è stato eseguito con tre repliche e, ad intervalli di tempo prestabiliti, i terreno sono stati campionati ed è stata rilevata la concentrazione di P in ogni terreno.\n\n```{r setup, cache = F, echo = F}\n#Put at the beginning\nknitr::knit_hooks$set(document = function(x){ \n  gsub(\"```\\n*```r*\\n*\", \"\", x) \n})\n#devtools::install_github(\"OnofriAndreaPG/aomisc\")\n```\n\nCarichiamo i dati, presenti nel package aomisc:\n\n```{r}\nlibrary(aomisc)\ndata(Phen)\nhead(Phen)\n```\n\nDato che intendiamo studiare cinetiche di degradazione, dobbiamo tener presente che queste sono lineari solo se consideriamo il logaritmo della concentrazione.\n\n# Anova\n\nDato che si tratta di una prova sperimentale con tre repliche, iniziamo le analisi con un'ANOVA, dove anche la variabile 'Temp', così come 'Tesi', viene considerata un fattore qualitativo (factor). Ovviamente, consideriamo non la concentrazione, ma il suo logaritmo.\n\n```{r}\nmodel <- lm(log(Conc) ~ factor(Tempo)*Tesi, data=Phen)\nanova(model)\n```\n\nA questo punto possiamo verificare le assunzioni di base per i modelli lineari, utilizzando l'analisi grafica dei residui.\n\n```{r}\npar(mfrow=c(2,2))\nplot(model)\nbartlett.test(log(Conc) ~ I(Tesi:factor(Tempo)), data=Phen)\ncar::leveneTest(log(Conc) ~ I(Tesi:factor(Tempo)), data=Phen)\nshapiro.test(residuals(model))\n```\n\nNon si ravvisano evidenti violazioni, anche se è utile considerare che, se i dati sono normali e omoscedastici sulla scala logaritmica, evidentemente non potevano esserlo sulla scala originale. Di conseguenza, la trasformazione logaritmica effettuata per linearizzare la cinetica di degradazione ha avuto anche un effetto benefico in termini di assunzioni di base per i modelli lineari.\n\n# Analisi dei dati: tre rette diverse\n\nIn questo caso le unità sperimentali sono chiaramente divisibili in quattro gruppi in quanto appartengono a combinazioni erbicide diverse. Di conseguenza, è possibile in partenza ipotizzare l’esistenza di quattro rette, una per ogni combinazione erbicida.\n\nIn R, questo tipo di modello lineare (tante intercette e tante pendenze quanti sono i livelli della variabile categorica), può essere codificato in questo modo:\n\n    Conc ~ Tesi  / Tempo - 1 \n\nove il carattere ’/’ indica un effetto gerarchico e il simbolo ’- 1’ indica che dal modello deve essere rimossa l’intercetta comune a tutti i dati, che viene calcolata per *default*.\n\nLa stima dei parametri ci porta ai seguenti risultati:\n\n\n```{r}\nmodel.1 <- lm(log(Conc) ~ Tesi  / Tempo - 1, data=Phen) \nsummary(model.1)\n```\n\nPossiamo visualizzare il fitting in questo modo:\n\n```{r}\n#Calcolo medie\nhead(Phen)\nPhen$logConc <- log(Phen$Conc)\nMedie <- plyr::ddply(Phen, c(\"Tesi\", \"Tempo\"), \n      function(df) c(Mean=mean(df$logConc)))\nplot(Medie$Mean ~ Medie$Tempo, subset=c(Medie$Tesi==\"P\"), ylim=c(0,5))\npoints(Medie$Mean ~ Medie$Tempo, subset=c(Medie$Tesi==\"PC\"), pch=2)\npoints(Medie$Mean ~ Medie$Tempo, subset=c(Medie$Tesi==\"PM\"), pch=3)\npoints(Medie$Mean ~ Medie$Tempo, subset=c(Medie$Tesi==\"PCM\"), pch=4)\nabline(a=coef(model.1)[1], b=coef(model.1)[4], lty=1)\nabline(a=coef(model.1)[2], b=coef(model.1)[5], lty=2)\nabline(a=coef(model.1)[3], b=coef(model.1)[6], lty=3)\n```\n\nUn test F per la mancanza d'adattamento conferma il buon fitting del modello ANCOVA.\n\n```{r}\nanova(model, model.1)\n```\n\n\nIn particolare, possiamo notare che la devianza del residuo è pari a 23.2, con 36 gradi di libertà. Pendenze e intercette sono tutte ben stimate e significativamente diverse da zero. Inoltre, il test F di lack of fit non è significativo (F = 1.9538) anche se è appena al di sopra della soglia di significanza.\n\n# Test di parallelismo\n\nA partire da questo modello completo, si può ipotizzare che le curve siano parallele, cioè condividano la stessa pendenza. Il grafico precedentemente mostrato contraddice questa ipotesi, ma eseguiremo il test ugualmente, per esercizio. Un modello a ’rette parallele’ può essere codificato in questo modo:\n\n```{r}\nmodel.2 <- lm(Peso ~ Specie + Conc - 1, data = CO2)\nsummary(model.2)\n```\n\nOsserviamo il grafico:\n\n```{r}\nplot(Medie$Mean ~ Medie$Conc, subset=c(Medie$Specie==\"A\"))\npoints(Medie$Mean ~ Medie$Conc, subset=c(Medie$Specie==\"B\"), pch=2)\npoints(Medie$Mean ~ Medie$Conc, subset=c(Medie$Specie==\"C\"), pch=3)\nabline(a=coef(model.2)[1], b=coef(model.2)[4], lty=1)\nabline(a=coef(model.2)[2], b=coef(model.2)[4], lty=2)\nabline(a=coef(model.2)[3], b=coef(model.2)[4], lty=3)\n```\n\n\nVediamo che l'adattamento, rispetto al modello precedente, è sensibilmente peggiorato. Per confermare questo, eseguiamo l'ANOVA della regressione:\n\n```{r}\nanova(model.2)\n```\n\n\nPossiamo notare che la devianza del residuo è salita a 138.1 con 38 gradi di libertà, quindi la rimozione di due parametri dal modello ha comportato un incremento della devianza del residuo pari a 114.8 e dei gradi di libertà ad esso relativi pari a 2. In altre parole, il modello a rette parallele descrive i dati ’meno bene’ di quello completo, si tratta di vedere se l’incremento dell’anzidetta devianza sia significativo o no. Per questo si può utilizzare un test di F, nella forma:\n\n$$F = \\frac{\\frac{SS_p  - SS_c }{DF_p  - DF_c }}{\\frac{SS_c }{DF_c }} = \\frac{\\frac{138.1 - 23.2}{38 - 36}}{\\frac{23.2}{36}} = 89.15$$\n\n\nDove $SS_c$ e $SS_p$ sone le devianze residue del modello completo e del modello a rette parallele, rispettivamente, con i relativi gradi di libertà $DF_c$ e $DF_p$. Il test di F ha 2 gradi di libertà al numeratore, 36 gradi di libertà al denominatore e permette di rifiutare l’ipotesi nulla con una probabilità di errore estremamente bassa.\n\n```{r}\nanova(model.2, model.1)\n```\n\nConfermiamo quindi che le due curve non possono essere considerate parallele.\n\n# Intercetta comune e diverse pendenze\n\nUn possibile modello alternativo prevede che le tre rette abbiano diverse pendenze ed un intercetta comune. In questo caso si opera come segue:\n\n\n```{r}\nmodel.3 <- lm(Peso ~ Specie / Conc - Specie, data=CO2)\nsummary(model.3)\n```\n\nIl modello appare più ragionevole del precedente, ma non ancora buono in assoluto.\n\n```{r}\nplot(Medie$Mean ~ Medie$Conc, subset=c(Medie$Specie==\"A\"))\npoints(Medie$Mean ~ Medie$Conc, subset=c(Medie$Specie==\"B\"), pch=2)\npoints(Medie$Mean ~ Medie$Conc, subset=c(Medie$Specie==\"C\"), pch=3)\nabline(a=coef(model.3)[1], b=coef(model.3)[2], lty=1)\nabline(a=coef(model.3)[1], b=coef(model.3)[3], lty=2)\nabline(a=coef(model.3)[1], b=coef(model.3)[4], lty=3)\nanova(model.3)\nanova(model.1, model.3)\n```\n\nInfatti, analogamente al modello precedente, la significatività del test di F (p = 6.03 $\\cdot 10^{-11}$) suggerisce che l’ipotesi di eguaglianza delle intercette non è accettabile e deve essere rifiutata\n\n# Parametrizzazioni alternative con R\n\nIn R esistono molte possibilità alternative per la parametrizzazione dei modelli ANCOVA. Ad esempio proviamo a codificare il modello come segue:\n\n\n```{r}\nmodel.4 <- lm(Peso ~ Specie * Conc, data=CO2)\nsummary(model.4)\n```\n\n\nOtteniamo ancora tre intercette e tre pendenza, ma stavolta esse sono espresse in modo diverso. In particolare, l’intercetta e la pendenza della curva A (la prima in ordine alfabetico) sono esplicite (7.69 e 0.26), mentre le pendenze e le intercette di B e C sono espresse come differenze rispetto ad A. Questo modo di codificare il modello è comodo, perchè ci mostra subito che l’intercetta di B è diversa da A mentre quella di C non lo è, mentre le tre pendenze sono significativamente diverse tra loro (si veda la significanza dei parametri, a destra).\n\nPer quanto riguarda il modello a ’rette parallele’, una parametrizzazione alternativa è la seguente:\n\n```{r}\nmodel.5 <- lm(Peso ~ Specie + Conc, data=CO2)\nsummary(model.5)\n```\n\n\nAnche qui le intercette di B e C sono espresse in termini di differenza rispetto ad A. Per quanto riguarda invece il modello ad intercetta comune, una parametrizzazione alternativa è la seguente.\n\n```{r}\nmodel.6 <- lm(Peso ~ Conc / Specie, data=CO2)\nsummary(model.6)\n```\n\nGli sviluppi di questa tecnica sono notevoli e consentono di testare in modo elegante molte ipotesi biologiche rilevanti.\n\n# Per approfondire\n\nBates, D. M., and Watts, D. G. (1988). Nonlinear regression analysis & its applications. John Wiley & Sons, Inc., New York, 365 pp.\\\nDraper, N. R., and Smith, H. (1981). Applied regression. John Wiley & Sons, Inc., New York, 2nd ed.\\\n",
    "created" : 1528884349239.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3439555292",
    "id" : "F604D90E",
    "lastKnownWriteTime" : 1528897904,
    "last_content_update" : 1528899093586,
    "path" : "~/Documents/_DBXAndrea/Dropbox/_Lavoro/__Notes/__Stats/40 - LinearModels/ANCOVA_Models/ANCOVA.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}